name: Main Branch Push

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'services/phoenix/**'
      - '.github/workflows/_reusable-*.yaml'
      - '.github/workflows/main-push.yaml'
      - '.github/release-please-*.json'

permissions:
  contents: write
  pull-requests: write

jobs:
  validate-docs:
    name: Validate Documentation
    uses: ./.github/workflows/_reusable-docs-cicd.yaml

  validate-phoenix:
    name: Validate Phoenix Service
    uses: ./.github/workflows/_reusable-phoenix-ci.yaml

  release-please:
    name: Create Release
    needs: [validate-docs, validate-phoenix]
    runs-on: ubuntu-24.04
    outputs:
      released: ${{ steps.release-please.outputs.release_created }}
      tag: ${{ steps.release-please.outputs.tag_name }}
    
    env:
      ACT: false # Default value for ACT
    
    steps:
      - name: Skip Release (Running Locally)
        if: ${{ env.ACT }}
        run: |
          echo "ℹ️  Skipping release when running locally with 'act'"
          echo "   Release creation requires GitHub tokens that are not available locally"
      
      - name: Run Release Please
        if: ${{ !env.ACT && github.ref == 'refs/heads/main' }}
        uses: googleapis/release-please-action@v4
        id: release-please
        with:
          config-file: .github/release-please-config.json
          manifest-file: .github/release-please-manifest.json
