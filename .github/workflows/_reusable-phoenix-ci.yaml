name: Phoenix Service CI (Reusable)

on:
  workflow_call:

jobs:
  validate-phoenix:
    name: Validate Phoenix Service
    runs-on: ubuntu-24.04
    defaults:
      run:
        working-directory: services/phoenix
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Install DevSpace
        run: npm install -g devspace

      - name: Validate Helm Chart Dependencies
        run: |
          helm dependency update chart/
          helm dependency build chart/

      - name: Lint Helm Chart
        run: |
          helm lint chart/

      - name: Validate Helm Template Rendering
        run: |
          helm template phoenix chart/ \
            --namespace phoenix \
            --debug \
            --dry-run

      - name: Validate DevSpace Configuration
        run: |
          devspace print

      - name: Check DevSpace Config Syntax
        run: |
          devspace list profiles

  test-phoenix-deployment:
    name: Test Phoenix Deployment
    runs-on: ubuntu-24.04
    needs: validate-phoenix
    defaults:
      run:
        working-directory: services/phoenix
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kind (Kubernetes in Docker)
        uses: helm/kind-action@v1
        with:
          cluster_name: phoenix-test
          kubectl_version: v1.29.0

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Install DevSpace
        run: npm install -g devspace

      - name: Create required namespaces
        run: |
          kubectl create namespace ark-system || true
          kubectl create namespace phoenix || true

      - name: Test Helm Installation
        run: |
          helm dependency update chart/
          helm install phoenix-test chart/ \
            --namespace phoenix \
            --wait \
            --timeout 5m

      - name: Verify Phoenix Deployment
        run: |
          kubectl get pods -n phoenix
          kubectl get svc -n phoenix
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/instance=phoenix-test -n phoenix --timeout=300s
          
      - name: Cleanup
        if: always()
        run: |
          helm uninstall phoenix-test -n phoenix || true
          kubectl delete namespace phoenix || true
